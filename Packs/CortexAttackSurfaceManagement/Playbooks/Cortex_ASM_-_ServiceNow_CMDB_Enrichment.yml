id: Cortex ASM - ServiceNow CMDB Enrichment
version: -1
name: Cortex ASM - ServiceNow CMDB Enrichment
description: Given the IP address this playbook enriches ServiceNow CMDB information relevant to ASM alerts.
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 0c7e23e2-baec-44bb-8904-181ed2f338c7
    type: start
    task:
      id: 0c7e23e2-baec-44bb-8904-181ed2f338c7
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "14"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 390,
          "y": 20
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 38d7e08f-ed1c-430e-8365-1ff7b12a0a50
    type: title
    task:
      id: 38d7e08f-ed1c-430e-8365-1ff7b12a0a50
      version: -1
      name: Set Field
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "12"
      - "13"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 390,
          "y": 310
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: f2571992-9ab9-4f9c-81d5-4ca0a47b61e5
    type: condition
    task:
      id: f2571992-9ab9-4f9c-81d5-4ca0a47b61e5
      version: -1
      name: Is ServiceNow v2 enabled?
      description: Determines if the "ServiceNow v2" integration instance is enabled in order to find email accounts for ServiceNow usernames.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "6"
      "yes":
      - "3"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: ServiceNow v2
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -10,
          "y": 840
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 62eb5daf-2c73-4f29-8b22-1e421cacf44d
    type: regular
    task:
      id: 62eb5daf-2c73-4f29-8b22-1e421cacf44d
      version: -1
      name: Pull ServiceNow user information
      description: Pull information on the user that was "assigned_to" for a CMDB object.
      script: ServiceNow v2|||servicenow-query-users
      type: regular
      iscommand: true
      brand: ServiceNow v2
    nexttasks:
      '#none#':
      - "7"
    scriptarguments:
      user_id:
        complex:
          root: ServiceNowCMDB.Record.Attributes.assigned_to
          accessor: value
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -280,
          "y": 1030
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: f350b6c5-fb7f-445b-8205-e15129d21532
    type: title
    task:
      id: f350b6c5-fb7f-445b-8205-e15129d21532
      version: -1
      name: Service Owner
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -10,
          "y": 710
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: d70dda29-97be-409f-8266-08365b221b06
    type: title
    task:
      id: d70dda29-97be-409f-8266-08365b221b06
      version: -1
      name: System IDs
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "8"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 750,
          "y": 710
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 156bb48a-973f-4588-88fd-09b5b7b7b701
    type: regular
    task:
      id: 156bb48a-973f-4588-88fd-09b5b7b7b701
      version: -1
      name: Set service owner grid field (no email)
      description: |-
        Automation used to more easily populate a grid field. This is necessary when you want to assign certain values as static or if you have context paths that you will assign to different values as well. For example:
        `!GridFieldSetup keys=ip,src val1=${AWS.EC2.Instances.NetworkInterfaces.PrivateIpAddress} val2="AWS" gridfiled="gridfield"`
      scriptName: GridFieldSetup
      type: regular
      iscommand: false
      brand: Builtin
    nexttasks:
      '#none#':
      - "10"
    scriptarguments:
      gridfield:
        simple: asmserviceowner
      keys:
        simple: Name,Email,Source,Timestamp
      val1:
        complex:
          root: ServiceNowCMDB.Record.Attributes.assigned_to
          accessor: display_value
      val2:
        simple: n/a
      val3:
        simple: SNOW-CMDB
      val4:
        simple: TIMESTAMP
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 170,
          "y": 1030
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: 766a4043-d7f3-4ebd-860c-0ec0e6b630c0
    type: regular
    task:
      id: 766a4043-d7f3-4ebd-860c-0ec0e6b630c0
      version: -1
      name: Set service owner grid field (email)
      description: |-
        Automation used to more easily populate a grid field. This is necessary when you want to assign certain values as static or if you have context paths that you will assign to different values as well. For example:
        `!GridFieldSetup keys=ip,src val1=${AWS.EC2.Instances.NetworkInterfaces.PrivateIpAddress} val2="AWS" gridfiled="gridfield"`
      scriptName: GridFieldSetup
      type: regular
      iscommand: false
      brand: Builtin
    nexttasks:
      '#none#':
      - "10"
    scriptarguments:
      gridfield:
        simple: asmserviceowner
      keys:
        simple: Name,Email,Source,Timestamp
      val1:
        complex:
          root: ServiceNowCMDB.Record.Attributes.assigned_to
          accessor: display_value
      val2:
        complex:
          root: ServiceNow.User
          accessor: Email
      val3:
        simple: SNOW-CMDB
      val4:
        simple: TIMESTAMP
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -280,
          "y": 1200
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: c83d1caf-725f-4454-8342-e410a3e7c814
    type: regular
    task:
      id: c83d1caf-725f-4454-8342-e410a3e7c814
      version: -1
      name: Set system IDs grid field (NIC)
      description: |-
        Automation used to more easily populate a grid field. This is necessary when you want to assign certain values as static or if you have context paths that you will assign to different values as well. For example:
        `!GridFieldSetup keys=ip,src val1=${AWS.EC2.Instances.NetworkInterfaces.PrivateIpAddress} val2="AWS" gridfiled="gridfield"`
      scriptName: GridFieldSetup
      type: regular
      iscommand: false
      brand: Builtin
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      gridfield:
        simple: asmsystemids
      keys:
        simple: Type,ID,Link
      val1:
        simple: SNOW-CMDB-NIC
      val2:
        complex:
          root: ServiceNowCMDB.Records.[0]
          accessor: sys_id
      val3:
        simple: n/a
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 750,
          "y": 840
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: 3c9e4ef6-b499-454a-87ef-73af6b708e02
    type: regular
    task:
      id: 3c9e4ef6-b499-454a-87ef-73af6b708e02
      version: -1
      name: Set system IDs grid field (Parent)
      description: |-
        Automation used to more easily populate a grid field. This is necessary when you want to assign certain values as static or if you have context paths that you will assign to different values as well. For example:
        `!GridFieldSetup keys=ip,src val1=${AWS.EC2.Instances.NetworkInterfaces.PrivateIpAddress} val2="AWS" gridfiled="gridfield"`
      scriptName: GridFieldSetup
      type: regular
      iscommand: false
      brand: Builtin
    nexttasks:
      '#none#':
      - "24"
    scriptarguments:
      gridfield:
        simple: asmsystemids
      keys:
        simple: Type,ID,Link
      val1:
        simple: SNOW-CMDB-Parent
      val2:
        complex:
          root: ServiceNowCMDB.Record
          accessor: SysID
      val3:
        simple: n/a
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 750,
          "y": 1000
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: 6f170d28-d7d6-41aa-8110-18487583fae1
    type: regular
    task:
      id: 6f170d28-d7d6-41aa-8110-18487583fae1
      version: -1
      name: Set system IDs grid field (Assigned)
      description: |-
        Automation used to more easily populate a grid field. This is necessary when you want to assign certain values as static or if you have context paths that you will assign to different values as well. For example:
        `!GridFieldSetup keys=ip,src val1=${AWS.EC2.Instances.NetworkInterfaces.PrivateIpAddress} val2="AWS" gridfiled="gridfield"`
      scriptName: GridFieldSetup
      type: regular
      iscommand: false
      brand: Builtin
    nexttasks:
      '#none#':
      - "23"
    scriptarguments:
      gridfield:
        simple: asmsystemids
      keys:
        simple: Type,ID,Link
      val1:
        simple: SNOW-CMDB-ASSIGN
      val2:
        complex:
          root: ServiceNowCMDB.Record.Attributes.assigned_to
          accessor: value
      val3:
        complex:
          root: ServiceNowCMDB.Record.Attributes.assigned_to
          accessor: link
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 10,
          "y": 1385
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: ce8fc0bf-2a74-4ac8-88e8-05c9bb79c9ea
    type: regular
    task:
      id: ce8fc0bf-2a74-4ac8-88e8-05c9bb79c9ea
      version: -1
      name: Set system IDs grid field (Company)
      description: |-
        Automation used to more easily populate a grid field. This is necessary when you want to assign certain values as static or if you have context paths that you will assign to different values as well. For example:
        `!GridFieldSetup keys=ip,src val1=${AWS.EC2.Instances.NetworkInterfaces.PrivateIpAddress} val2="AWS" gridfiled="gridfield"`
      scriptName: GridFieldSetup
      type: regular
      iscommand: false
      brand: Builtin
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      gridfield:
        simple: asmsystemids
      keys:
        simple: Type,ID,Link
      val1:
        simple: SNOW-CMDB-COMPANY
      val2:
        complex:
          root: ServiceNowCMDB.Record.Attributes.company
          accessor: value
      val3:
        complex:
          root: ServiceNowCMDB.Record.Attributes.company
          accessor: link
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 640,
          "y": 1520
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: 4482df99-e176-4338-8653-dd96496f1241
    type: condition
    task:
      id: 4482df99-e176-4338-8653-dd96496f1241
      version: -1
      name: Is there ServiceNow assigned_to information?
      description: Determines if there is ServiceNow assigned_to information to set in the service owner field.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "25"
      "yes":
      - "4"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: ServiceNowCMDB.Record.Attributes.assigned_to
                accessor: display_value
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -10,
          "y": 470
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: f5505d9b-9f2c-4f60-8344-f3846adc84bc
    type: condition
    task:
      id: f5505d9b-9f2c-4f60-8344-f3846adc84bc
      version: -1
      name: Is there ServiceNow record and records information?
      description: Determines if there is ServiceNow record and records information to set in the system ID field.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "25"
      "yes":
      - "5"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: ServiceNowCMDB
                accessor: Records
            iscontext: true
          right:
            value: {}
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: ServiceNowCMDB
                accessor: Record
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 750,
          "y": 470
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 071330c6-39db-4c00-851a-dc07c385ae8b
    type: playbook
    task:
      id: 071330c6-39db-4c00-851a-dc07c385ae8b
      version: -1
      name: ServiceNow CMDB Search
      description: |
        Subplaybook for finding CI records in ServiceNow CMDB.
      playbookName: ServiceNow CMDB Search
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "1"
    scriptarguments:
      BypassAddRecord:
        simple: "true"
      SearchCIClass:
        simple: cmdb_ci
      SearchQueryField:
        simple: ip_address
      SearchQueryValue:
        complex:
          root: inputs.RemoteIP
    separatecontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 390,
          "y": 150
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: c7c98192-cb36-4335-86f0-7b7390e31fe4
    type: condition
    task:
      id: c7c98192-cb36-4335-86f0-7b7390e31fe4
      version: -1
      name: Is there ServiceNow company information?
      description: Determines if there is ServiceNow company information to set in the systemID field.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "22"
      "yes":
      - "11"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: ServiceNowCMDB.Record.Attributes.company
                accessor: value
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 750,
          "y": 1325
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: 8a82f9a1-3c3f-4088-8657-1aa3b6c81926
    type: regular
    task:
      id: 8a82f9a1-3c3f-4088-8657-1aa3b6c81926
      version: -1
      name: Set ASM enrichment status
      description: |-
        Automation used to more easily populate a grid field.  This is necessary when you want to assign certain values as static or if you have context paths that you will assign to different values as well.  Instead of a value you can enter `TIMESTAMP` to get the current timestamp in ISO format. For example:
        `!GridFieldSetup keys=ip,src,timestamp val1=${AWS.EC2.Instances.NetworkInterfaces.PrivateIpAddress} val2="AWS" val3="TIMESTAMP" gridfiled="gridfield"`
      scriptName: GridFieldSetup
      type: regular
      iscommand: false
      brand: Builtin
    nexttasks:
      '#none#':
      - "20"
    scriptarguments:
      gridfield:
        simple: asmenrichmentstatus
      keys:
        simple: source,record_exists,timestamp
      val1:
        simple: ServiceNow CMDB
      val2:
        complex:
          root: asm_enrichment_status_flag_servicenow_cmdb
      val3:
        simple: TIMESTAMP
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1050,
          "y": 2070
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: bc208cb1-eb05-4738-8fa1-8b1bd89d9137
    type: title
    task:
      id: bc208cb1-eb05-4738-8fa1-8b1bd89d9137
      version: -1
      name: Complete
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1050,
          "y": 2250
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: 54b942f0-530b-41f6-866b-f2fba0d1a018
    type: title
    task:
      id: 54b942f0-530b-41f6-866b-f2fba0d1a018
      version: -1
      name: Closing Steps
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "19"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1050,
          "y": 1910
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "23":
    id: "23"
    taskid: 90553b2f-7a9a-47e9-808d-b3a9d2b0dbde
    type: regular
    task:
      id: 90553b2f-7a9a-47e9-808d-b3a9d2b0dbde
      version: -1
      name: Set flag for enrichment status to true
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      key:
        simple: asm_enrichment_status_flag_servicenow_cmdb
      value:
        simple: "true"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 10,
          "y": 1565
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: 4e6b799a-dd56-477b-8529-ab4bdc9114ff
    type: regular
    task:
      id: 4e6b799a-dd56-477b-8529-ab4bdc9114ff
      version: -1
      name: Set flag for enrichment status to true
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      key:
        simple: asm_enrichment_status_flag_servicenow_cmdb
      value:
        simple: "true"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 750,
          "y": 1160
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: 7b5a601f-400e-4848-8994-90ce63ca5f42
    type: regular
    task:
      id: 7b5a601f-400e-4848-8994-90ce63ca5f42
      version: -1
      name: Set flag for enrichment status to false
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      key:
        simple: asm_enrichment_status_flag_servicenow_cmdb
      value:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 390,
          "y": 1705
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "12_25_#default#": 0.27,
      "12_4_yes": 0.39,
      "13_25_#default#": 0.22,
      "13_5_yes": 0.53,
      "17_11_yes": 0.5,
      "2_6_#default#": 0.52
    },
    "paper": {
      "dimensions": {
        "height": 2295,
        "width": 1710,
        "x": -280,
        "y": 20
      }
    }
  }
inputs:
- key: RemoteIP
  value:
    complex:
      root: alert
      accessor: remoteip
  required: true
  description: IP address of service
  playbookInputQuery:
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.5.0
